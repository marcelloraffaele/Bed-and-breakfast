name: Push Helm Chart to ACR

on:
  workflow_dispatch:
    inputs:
      chart-version:
        description: 'Helm chart version to use'
        required: false
        default: '0.1.0'
        type: string

env:
  CHART_NAME: bb-chart
  CHART_PATH: ./bb-chart

jobs:
  push-helm-chart:
    name: Package and Push Helm Chart
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code 
        uses: actions/checkout@v3

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: 'latest'

      - name: Get ACR name and login
        id: acr-name
        run: |
          $acrName = "${{ secrets.registry }}" -replace '\.azurecr\.io$', ''
          echo "name=$acrName" >> $env:GITHUB_OUTPUT
          echo "registry=${{ secrets.registry }}" >> $env:GITHUB_OUTPUT
          az acr login --name $acrName
        shell: pwsh

      - name: Update chart version and package
        run: |
          (Get-Content ${{ env.CHART_PATH }}/Chart.yaml) -replace '^version:.*', "version: ${{ github.event.inputs.chart-version }}" | Set-Content ${{ env.CHART_PATH }}/Chart.yaml
          helm package ${{ env.CHART_PATH }} -d .
        shell: pwsh

      - name: Push Helm chart to ACR
        run: |
          helm push ${{ github.workspace }}/${{ env.CHART_NAME }}-${{ github.event.inputs.chart-version }}.tgz oci://${{ steps.acr-name.outputs.registry }}/helm

      - name: Logout from ACR
        if: always()
        run: |
          helm registry logout ${{ steps.acr-name.outputs.registry }}
        shell: bash

      - name: Display completion message
        run: |
          echo "âœ… Helm chart ${{ env.CHART_NAME }}:${{ github.event.inputs.chart-version }} successfully pushed to ACR"
          echo "ðŸ“¦ Chart location: oci://${{ steps.acr-name.outputs.registry }}/helm/${{ env.CHART_NAME }}"
